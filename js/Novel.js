// Novel data structure updated to include episodes
const novels = [
    {
        id: 1,
        title: "මග හැරුණු හීනේ කුමාරී",
        author: "Tharuka Sewwandi",
        genre: "Romance",
        coverImg: "img/මග හැරුණු හීනේ කුමාරී.jpg",
        shortDescription: "A passionate love story set in the city of lights.",
        description: "When Elise meets Jacques on a rainy evening in Montmartre, she doesn't expect their chance encounter to change her life forever. Set against the romantic backdrop of Paris, this novel explores passion, art, and the unexpected ways love transforms us.",
        Episodes: 23,
        episodes: [
                {
                    id: 1,
                    title: "Intro",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Introduction.txt"
                },
                {
                    id: 2,
                    title: "Episode 01",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 01.txt"
                },
                
                {
                    id: 3,
                    title: "Episode 02",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 02.txt"
                },
                {
                    id: 4,
                    title: "Episode 03",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 03.txt"
                },
                {
                    id: 5,
                    title: "Episode 04",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 04.txt"
                },
                {
                    id: 6,
                    title: "Episode 05",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 05.txt"
                },
                {
                    id: 7,
                    title: "Episode 06",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 06.txt"
                },
                {
                    id: 8,
                    title: "Episode 07",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 07.txt"
                },
                {
                    id: 9,
                    title: "Episode 08",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 08.txt"
                },
                {
                    id: 10,
                    title: "Episode 09",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 09.txt"
                },
                {
                    id: 11,
                    title: "Episode 10",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 10.txt"
                },
                {
                    id: 12,
                    title: "Episode 11",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 11.txt"
                },
                {
                    id: 13,
                    title: "Episode 12",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 12.txt"
                },
                {
                    id: 14,
                    title: "Episode 13",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 13.txt"
                },
                {
                    id: 15,
                    title: "Episode 14",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 14.txt"
                },
                {
                    id: 16,
                    title: "Episode 15",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 15.txt"
                },
                {
                    id: 17,
                    title: "Episode 16",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 16.txt"
                },
                {
                    id: 18,
                    title: "Episode 17",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 17.txt"
                },
                {
                    id: 19,
                    title: "Episode 18",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 18.txt"
                },
                {
                    id: 20,
                    title: "Episode 19",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 19.txt"
                },
                {
                    id: 21,
                    title: "Episode 20",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 20.txt"
                },
                {
                    id: 22,
                    title: "Episode 21",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 21.txt"
                },
                {
                    id: 23,
                    title: "Episode 22",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 22.txt"
                },
                {
                    id: 24,
                    title: "Episode 23",
                    txtUrl: "Novels/මග හැරුණු හීනේ කුමාරී/Episode 23.txt"
                }
        ]
    },
    {
        id: 2,
        title: "නුඹ දුරද තවම මට",
        author: "Tharuka Sewwandi",
        genre: "Romance",
        coverImg: "img/නුඹ දුරද තවම මට.jpg",
        shortDescription: "A passionate love story set in the city of lights.",
        description: "When Elise meets Jacques on a rainy evening in Montmartre, she doesn't expect their chance encounter to change her life forever. Set against the romantic backdrop of Paris, this novel explores passion, art, and the unexpected ways love transforms us.",
        Episodes: 80,
        publishDate: "2023-10-01",
        episodes: [
            {
                id: 1,
                title: "Intro",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Introduction.txt"
            },
            {
                id: 2,
                title: "Episode 01",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 01.txt"
            },
            {
                id: 3,
                title: "Episode 02",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 02.txt"
            },
            {
                id: 4,
                title: "Episode 03",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 03.txt"
            },
            {
                id: 5,
                title: "Episode 04",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 04.txt"
            },
            {
                id: 6,
                title: "Episode 05",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 05.txt"
            },
            {
                id: 7,
                title: "Episode 06",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 06.txt"
            },
            {
                id: 8,
                title: "Episode 07",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 07.txt"
            },
            {
                id: 9,
                title: "Episode 08",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 08.txt"
            },
            {
                id: 10,
                title: "Episode 09",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 09.txt"
            },
            {
                id: 11,
                title: "Episode 10",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 10.txt"
            },
            {
                id: 12,
                title: "Episode 11",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 11.txt"
            },
            {
                id: 13,
                title: "Episode 12",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 12.txt"
            },
            {
                id: 14,
                title: "Episode 13",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 13.txt"
            },
            {
                id: 15,
                title: "Episode 14",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 14.txt"
            },
            {
                id: 16,
                title: "Episode 15",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 15.txt"
            },
            {
                id: 17,
                title: "Episode 16",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 16.txt"
            },
            {
                id: 18,
                title: "Episode 17",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 17.txt"
            },
            {
                id: 19,
                title: "Episode 18",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 18.txt"
            },
            {
                id: 20,
                title: "Episode 19",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 19.txt"
            },
            {
                id: 21,
                title: "Episode 20",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 20.txt"
            },
            {
                id: 22,
                title: "Episode 21",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 21.txt"
            },
            {
                id: 23,
                title: "Episode 22",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 22.txt"
            },
            {
                id: 24,
                title: "Episode 23",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 23.txt"
            },
            {
                id: 25,
                title: "Episode 24",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 24.txt"
            },
            {
                id: 26,
                title: "Episode 25",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 25.txt"
            },
            {
                id: 27,
                title: "Episode 26",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 26.txt"
            },
            {
                id: 28,
                title: "Episode 27",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 27.txt"
            },
            {
                id: 29,
                title: "Episode 28",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 28.txt"
            },
            {
                id: 30,
                title: "Episode 29",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 29.txt"
            },
            {
                id: 31,
                title: "Episode 30",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 30.txt"
            },
            {
                id: 32,
                title: "Episode 31",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 31.txt"
            },
            {
                id: 33,
                title: "Episode 32",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 32.txt"
            },
            {
                id: 34,
                title: "Episode 33",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 33.txt"
            },
            {
                id: 35,
                title: "Episode 34",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 34.txt"
            },
            {
                id: 36,
                title: "Episode 35",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 35.txt"
            },
            {
                id: 37,
                title: "Episode 36",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 36.txt"
            },
            {
                id: 38,
                title: "Episode 37",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 37.txt"
            },
            {
                id: 39,
                title: "Episode 38",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 38.txt"
            },
            {
                id: 40,
                title: "Episode 39",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 39.txt"
            },
            {
                id: 41,
                title: "Episode 40",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 40.txt"
            },
            {
                id: 42,
                title: "Episode 41",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 41.txt"
            },
            {
                id: 43,
                title: "Episode 42",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 42.txt"
            },
            {
                id: 44,
                title: "Episode 43",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 43.txt"
            },
            {
                id: 45,
                title: "Episode 44",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 44.txt"
            },
            {
                id: 46,
                title: "Episode 45",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 45.txt"
            },
            {
                id: 47,
                title: "Episode 46",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 46.txt"
            },
            {
                id: 48,
                title: "Episode 47",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 47.txt"
            },
            {
                id: 49,
                title: "Episode 48",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 48.txt"
            },
            {
                id: 50,
                title: "Episode 49",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 49.txt"
            },
            {
                id: 51,
                title: "Episode 50",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 50.txt"
            },
            {
                id: 52,
                title: "Episode 51",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 51.txt"
            },
            {
                id: 53,
                title: "Episode 52",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 52.txt"
            },
            {
                id: 54,
                title: "Episode 53",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 53.txt"
            },
            {
                id: 55,
                title: "Episode 54",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 54.txt"
            },
            {
                id: 56,
                title: "Episode 55",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 55.txt"
            },
            {
                id: 57,
                title: "Episode 56",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 56.txt"
            },
            {
                id: 58,
                title: "Episode 57",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 57.txt"
            },
            {
                id: 59,
                title: "Episode 58",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 58.txt"
            },
            {
                id: 60,
                title: "Episode 59",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 59.txt"
            },
            {
                id: 61,
                title: "Episode 60",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 60.txt"
            },
            {
                id: 62,
                title: "Episode 61",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 61.txt"
            },
            {
                id: 63,
                title: "Episode 62",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 62.txt"
            },
            {
                id: 64,
                title: "Episode 63",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 63.txt"
            },
            {
                id: 65,
                title: "Episode 64",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 64.txt"
            },
            {
                id: 66,
                title: "Episode 65",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 65.txt"
            },
            {
                id: 67,
                title: "Episode 66",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 66.txt"
            },
            {
                id: 68,
                title: "Episode 67",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 67.txt"
            },
            {
                id: 69,
                title: "Episode 68",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 68.txt"
            },
            {
                id: 70,
                title: "Episode 69",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 69.txt"
            },
            {
                id: 71,
                title: "Episode 70",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 70.txt"
            },
            {
                id: 72,
                title: "Episode 71",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 71.txt"
            },
            {
                id: 73,
                title: "Episode 72",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 72.txt"
            },
            {
                id: 74,
                title: "Episode 73",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 73.txt"
            },
            {
                id: 75,
                title: "Episode 74",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 74.txt"
            },
            {
                id: 76,
                title: "Episode 75",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 75.txt"
            },
            {
                id: 77,
                title: "Episode 76",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 76.txt"
            },
            {
                id: 78,
                title: "Episode 77",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 77.txt"
            },
            {
                id: 79,
                title: "Episode 78",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 78.txt"
            },
            {
                id: 80,
                title: "Episode 79",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 79.txt"
            },
            {
                id: 81,
                title: "Episode 80",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 80.txt"
            },
            {
                id: 82,
                title: "Episode 81",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Episode 81.txt"
            }
        ]
    },
    {
        id: 3,
        title: "මගේ සඳ නුඹ",
        author: "Tharuka Sewwandi",
        genre: "Romance",
        coverImg: "img/මගේ සඳ නුඹ.jpg",
        shortDescription: "A passionate love story set in the city of lights.",
        description: "When Elise meets Jacques on a rainy evening in Montmartre, she doesn't expect their chance encounter to change her life forever. Set against the romantic backdrop of Paris, this novel explores passion, art, and the unexpected ways love transforms us.",
        Episodes: 40,
        episodes: [
            {
                id: 1,
                title: "Intro",
                txtUrl: "Novels/මගේ සඳ නුඹ/Introduction.txt"
            }
        ]
    },
    {
        id: 4,
        title: "පිය මනිමු මල් මාවතේ",
        author: "Tharuka Sewwandi",
        genre: "Romance",
        coverImg: "img/පිය මනිමු මල් මාවතේ.jpg",
        shortDescription: "අහිමි වූ පියාගේ සෙනෙහස නැවත ලැබූ දියණියක්.",
        description: "අහිමිවුණ හැමදේම ආපහු ලැබෙන්නෙ නෑ, නමුත් ලැබෙන එකේ වටිනාකම තවත් කිසිදිනෙකත් අමතක කරන්නෙ නෑ. මේ නවකතාව කියන්නේ ඒ වටිනාකම අරුතෙන් යටපත් වෙලා පිරුණු ආදරයක ගමනක්.",
        Episodes: 28,
        episodes: [
            {
                id: 1,
                title: "Intro",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Introduction.txt"
            },
            {
                id: 2,
                title: "Episode 01",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 01.txt"
            },
            {
                id: 3,
                title: "Episode 02",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 02.txt"
            },
            {
                id: 4,
                title: "Episode 03",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 03.txt"
            },
            {
                id: 5,
                title: "Episode 04",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 04.txt"
            },
            {
                id: 6,
                title: "Episode 05",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 05.txt"
            },
            {
                id: 7,
                title: "Episode 06",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 06.txt"
            },
            {
                id: 8,
                title: "Episode 07",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 07.txt"
            },
            {
                id: 9,
                title: "Episode 08",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 08.txt"
            },
            {
                id: 10,
                title: "Episode 09",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 09.txt"
            },
            {
                id: 11,
                title: "Episode 10",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 10.txt"
            },
            {
                id: 12,
                title: "Episode 11",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 11.txt"
            },
            {
                id: 13,
                title: "Episode 12",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 12.txt"
            },
            {
                id: 14,
                title: "Episode 13",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 13.txt"
            },
            {
                id: 15,
                title: "Episode 14",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 14.txt"
            },
            {
                id: 16,
                title: "Episode 15",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 15.txt"
            },
            {
                id: 17,
                title: "Episode 16",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 16.txt"
            },
            {
                id: 18,
                title: "Episode 17",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 17.txt"
            },
            {
                id: 19,
                title: "Episode 18",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 18.txt"
            },
            {
                id: 20,
                title: "Episode 19",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 19.txt"
            },
            {
                id: 21,
                title: "Episode 20",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 20.txt"
            },
            {
                id: 22,
                title: "Episode 21",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 21.txt"
            },
            {
                id: 23,
                title: "Episode 22",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 22.txt"
            },
            {
                id: 24,
                title: "Episode 23",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 23.txt"
            },
            {
                id: 25,
                title: "Episode 24",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 24.txt"
            },
            {
                id: 26,
                title: "Episode 25",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 25.txt"
            },
            {
                id: 27,
                title: "Episode 26",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 26.txt"
            },
            {
                id: 28,
                title: "Episode 27",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 27.txt"
            },
            {
                id: 29,
                title: "Episode 28",
                txtUrl: "Novels/පිය මනිමු මල් මවතේ/Episode 28.txt"
            }
        ]
    },
    {
        id: 5,
        title: "ලං වී හදට රහසින්",
        author: "Tharuka Sewwandi",
        genre: "Romance",
        coverImg: "img/ලංවී හදට රහසින්.jpg",
        shortDescription: "A passionate love story set in the city of lights.",
        description: "When Elise meets Jacques on a rainy evening in Montmartre, she doesn't expect their chance encounter to change her life forever. Set against the romantic backdrop of Paris, this novel explores passion, art, and the unexpected ways love transforms us.",
        publishDate: "2023-10-01",
        Episodes: 24,
        episodes: [
            {
                id: 1,
                title: "Intro",
                txtUrl: "Novels/නුඹ දුරද තවම මට/Introduction.txt"
            }
        ]
    }
];


// Variables to track current state
let currentNovel = null;
let currentEpisode = null;
let currentPage = 1;
let totalPages = 10;
let currentFontSize = 16; // Base font size in pixels
let novelContent = []; // Will store the array of text content divided into pages

// DOM Ready
document.addEventListener('DOMContentLoaded', function() {
    // Create floating petals
    const petalsContainer = document.querySelector('.petals-container');
    if (petalsContainer) {
        for (let i = 0; i < 15; i++) {
            createPetal(petalsContainer);
        }
    }

    // Initialize filters
    filterNovels();

    
    setupSwipeControls();
    
    // Generate novel cards
    generateNovelCards();
    
    // Setup event listeners
    setupMobileMenu();
    setupThemeToggle();
    setupModals();
    
    // Animate page elements
    animatePageElements();
    
    // Apply current theme text colors
    applyThemeColors();
    
    // Load all novel ratings
    ratingSystem.loadAllNovelRatings();
});

// Generate novel cards from data
function generateNovelCards() {
    const novelsGrid = document.getElementById('novelsGrid');
    if (!novelsGrid) return;
    
    novelsGrid.innerHTML = '';
    
    // Create a copy of the novels array and reverse it
    const reversedNovels = [...novels].reverse();
    
    reversedNovels.forEach((novel, index) => {
        const card = document.createElement('div');
        card.className = 'novel-card h-full flex flex-col opacity-0 novels-item';
        card.dataset.novelId = novel.id;
        
        // Rest of the function remains the same
        card.innerHTML = `
            <div class="relative overflow-hidden scrollbar-hide rounded-t-lg h-94">
                <img src="${novel.coverImg}" alt="${novel.title}" class="w-full h-94 object-cover transition-transform duration-700 hover:scale-110">
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-4">
                    <span class="text-white font-medium px-3 py-1 rounded-full text-sm">${novel.genre}</span>
                </div>
            </div>
            <div class="p-5 flex flex-col flex-grow">
                <h3 class="text-xl font-bold mb-2">${novel.title}</h3>
                <p class="text-sm mb-3 flex-grow">${novel.shortDescription}</p>
                <div class="novel-rating mb-3">
                    <!-- Rating stars will be dynamically inserted here -->
                    <div class="flex items-center">
                        <div class="flex mr-1">
                            <i class="far fa-star text-yellow-400"></i>
                            <i class="far fa-star text-yellow-400"></i>
                            <i class="far fa-star text-yellow-400"></i>
                            <i class="far fa-star text-yellow-400"></i>
                            <i class="far fa-star text-yellow-400"></i>
                        </div>
                        <span class="text-xs text-gray-500 dark:text-gray-400">(0)</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm italic">By ${novel.author}</span>
                    <button class="read-now-btn btn-primary text-white px-4 py-2 rounded-lg">
                        View Details
                    </button>
                </div>
            </div>
        `;
        
        novelsGrid.appendChild(card);
        
        // Add click event to the Read Now button
        const readNowBtn = card.querySelector('.read-now-btn');
        readNowBtn.addEventListener('click', () => {
            openNovelModal(novel);
        });
    });
}

// Open novel detail modal with episodes
function openNovelModal(novel) {
    currentNovel = novel;
    
    // Update modal content
    document.getElementById('modalBookCover').src = novel.coverImg;
    document.getElementById('modalBookTitle').textContent = novel.title;
    document.getElementById('modalBookAuthor').textContent = `By ${novel.author}`;
    document.getElementById('modalBookGenre').textContent = novel.genre;
    document.getElementById('modalBookPages').textContent = `${novel.Episodes} Episodes`;
    document.getElementById('modalBookDescription').textContent = novel.description;
    
    // Generate episode cards
    generateEpisodeCards(novel);
    
    // Initialize and setup rating system
    const bookDetailsSection = document.getElementById('Scroll');
    
    // Remove any existing rating container
    const existingRatingContainer = bookDetailsSection.querySelector('.rating-container');
    if (existingRatingContainer) {
        existingRatingContainer.remove();
    }
    
    // Initialize rating UI
    ratingSystem.initRatingUI(bookDetailsSection);
    
    // Set current novel ID for rating
    ratingSystem.setNovelId(novel.id);
    
    // Show the modal
    document.getElementById('novelModal').classList.remove('hidden');
    
    // Add transition effects
    gsap.fromTo('#novelModal .modal-container', 
        { opacity: 0, y: 20, scale: 0.95 }, 
        { opacity: 1, y: 0, scale: 1, duration: 0.3, ease: 'power2.out' }
    );
}

// Generate episode cards for the selected novel
function generateEpisodeCards(novel) {
    // Get the episode container
    const episodesContainer = document.getElementById('episodesContainer');
    if (!episodesContainer) return;
    
    episodesContainer.innerHTML = '<h3 class="text-xl font-bold mb-4">Episodes</h3>';
    
    // Create grid for episodes
    const episodesGrid = document.createElement('div');
    episodesGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4';
    
    // Generate episode cards
    novel.episodes.forEach((episode, index) => {
        const episodeCard = document.createElement('div');
        episodeCard.className = 'episode-card relative rounded-lg overflow-hidden cursor-pointer';
        episodeCard.dataset.episodeId = episode.id;
        
        episodeCard.innerHTML = `
            <div class="relative w-full pt-[133%] bg-gradient-to-br from-pink-100 to-purple-200 dark:from-gray-700 dark:to-gray-800">
            <div class="absolute inset-0 flex items-center justify-center">
            <span class="episode-number text-6xl font-bold text-white opacity-50"> ${index === 0 ? 'IN' : `<span class="episode-number text-6xl font-bold text-white opacity-50">${index}</span>`}
            </div>
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent opacity-0 hover:opacity-100 transition-all duration-500 flex items-center justify-center group">
                <div class="transform translate-y-4 group-hover:translate-y-0 opacity-0 group-hover:opacity-100 transition-all duration-500 text-center p-2">
                <h4 class="font-bold text-white text-lg tracking-wide drop-shadow-lg">${episode.title}</h4>
                <span class="text-pink-200 text-sm mt-2 inline-block">Click to Read</span>
                </div>
            </div>
            </div>
        `;
        
        episodesGrid.appendChild(episodeCard);
        
        // Add click event to open the episode viewer
        episodeCard.addEventListener('click', () => {
            openEpisodeViewer(novel, episode);
        });
    });
    
    // Append the grid to the container
    episodesContainer.appendChild(episodesGrid);
}

// Load and display episode TXT file
async function loadEpisodeTxt(episode) {
    try {
        // Show loading state
        document.getElementById('txtContent').innerHTML = '<div class="flex justify-center items-center h-64"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500"></div></div>';
        
        // Fetch the TXT file content
        const response = await fetch(episode.txtUrl);
        if (!response.ok) throw new Error('Failed to load text file');
        
        const text = await response.text();
        
        // Display the entire text content instead of splitting into pages
        const txtContent = document.getElementById('txtContent');
        
        // Format the text with paragraphs
        const formattedText = text
            .replace(/\n\s*\n/g, '</p><p>')
            .replace(/\n/g, '<br>');
        
        txtContent.innerHTML = `<p>${formattedText}</p>`;
        txtContent.style.fontSize = `${currentFontSize}px`;
        
        // Apply theme-based text color
        applyThemeColors();
        
        // Hide page navigation controls since we're showing the full content
        document.getElementById('pageCounter').textContent = '';
        document.getElementById('prevPageBtn').style.display = 'none';
        document.getElementById('nextPageBtn').style.display = 'none';
        
    } catch (error) {
        console.error('Error loading TXT file:', error);
        document.getElementById('txtContent').innerHTML = `<div class="p-4 bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200 rounded">Error loading the episode: ${error.message}</div>`;
    }
}

// Apply theme-based text colors
function applyThemeColors() {
    const isDarkMode = document.body.classList.contains('dark-mode');
    const txtContent = document.getElementById('txtContent');
    
    if (txtContent) {
        if (isDarkMode) {
            txtContent.classList.add('text-gray-100');
            txtContent.classList.remove('text-gray-800');
        } else {
            txtContent.classList.add('text-gray-800');
            txtContent.classList.remove('text-gray-100');
        }
    }
}

// Change font size
function changeFontSize(delta) {
    // Limit font size between 12px and 24px
    const newSize = Math.max(12, Math.min(24, currentFontSize + delta));
    
    if (newSize !== currentFontSize) {
        currentFontSize = newSize;
        document.getElementById('txtContent').style.fontSize = `${currentFontSize}px`;
    }
}

// Open the episode viewer
function openEpisodeViewer(novel, episode) {
    currentEpisode = episode;
    
    // Update episode viewer content
    document.getElementById('txtTitle').textContent = `${novel.title} - ${episode.title}`;
    
    // Hide novel modal and show episode viewer
    document.getElementById('novelModal').classList.add('hidden');
    document.getElementById('txtViewerModal').classList.remove('hidden');
    
    // Load episode content
    loadEpisodeTxt(episode);
    
    // Enable/disable episode navigation buttons
    updateEpisodeNavigation();
    
    // Add transition effects
    gsap.fromTo('#txtViewerModal > div:last-child', 
        { opacity: 0, scale: 0.95 }, 
        { opacity: 1, scale: 1, duration: 0.3, ease: 'power2.out' }
    );
}

// Update episode navigation buttons
function updateEpisodeNavigation() {
    const prevEpisodeBtn = document.getElementById('prevEpisodeBtn');
    const nextEpisodeBtn = document.getElementById('nextEpisodeBtn');
    
    if (!currentNovel || !currentEpisode) return;
    
    const currentIndex = currentNovel.episodes.findIndex(ep => ep.id === currentEpisode.id);
    
    // Enable/disable previous episode button
    if (currentIndex <= 0) {
        prevEpisodeBtn.classList.add('opacity-50', 'cursor-not-allowed');
        prevEpisodeBtn.disabled = true;
    } else {
        prevEpisodeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        prevEpisodeBtn.disabled = false;
    }
    
    // Enable/disable next episode button
    if (currentIndex >= currentNovel.episodes.length - 1) {
        nextEpisodeBtn.classList.add('opacity-50', 'cursor-not-allowed');
        nextEpisodeBtn.disabled = true;
    } else {
        nextEpisodeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        nextEpisodeBtn.disabled = false;
    }
}

// Navigate to previous episode
function goToPrevEpisode() {
    if (!currentNovel || !currentEpisode) return;
    
    const currentIndex = currentNovel.episodes.findIndex(ep => ep.id === currentEpisode.id);
    if (currentIndex > 0) {
        openEpisodeViewer(currentNovel, currentNovel.episodes[currentIndex - 1]);
    }
}

// Navigate to next episode
function goToNextEpisode() {
    if (!currentNovel || !currentEpisode) return;
    
    const currentIndex = currentNovel.episodes.findIndex(ep => ep.id === currentEpisode.id);
    if (currentIndex < currentNovel.episodes.length - 1) {
        openEpisodeViewer(currentNovel, currentNovel.episodes[currentIndex + 1]);
    }
}

// Setup modals and event listeners
function setupModals() {
    // Novel Modal Close Button
    document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('novelModal').classList.add('hidden');
    });
    
    // TXT Viewer Close Button
    document.getElementById('closeTxtViewer').addEventListener('click', () => {
        document.getElementById('txtViewerModal').classList.add('hidden');
    });
    
    // Back to novel details button
    document.getElementById('backToNovelBtn').addEventListener('click', () => {
        document.getElementById('txtViewerModal').classList.add('hidden');
        openNovelModal(currentNovel);
    });
    
    // Font size controls
    document.getElementById('decreaseFontBtn').addEventListener('click', () => changeFontSize(-2));
    document.getElementById('increaseFontBtn').addEventListener('click', () => changeFontSize(2));
    
    // Fullscreen Toggle
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
        const elem = document.getElementById('txtViewerContainer');
        if (!document.fullscreenElement) {
            elem.requestFullscreen().catch(err => {
                alert(`Error attempting to enable fullscreen: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    });
    
    // Episode navigation
    document.getElementById('prevEpisodeBtn').addEventListener('click', goToPrevEpisode);
    document.getElementById('nextEpisodeBtn').addEventListener('click', goToNextEpisode);
    
    // Close modals when clicking overlay
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', () => {
            document.getElementById('novelModal').classList.add('hidden');
            document.getElementById('txtViewerModal').classList.add('hidden');
        });
    });
}

// Create floating petals for animation
function createPetal(container) {
    const petal = document.createElement('div');
    petal.classList.add('petal');
    
    // Random positions and sizes
    petal.style.left = `${Math.random() * 100}%`;
    petal.style.top = `${Math.random() * 100}%`;
    petal.style.width = `${10 + Math.random() * 15}px`;
    petal.style.height = `${10 + Math.random() * 15}px`;
    
    // Random animation delay and duration
    petal.style.animationDelay = `${Math.random() * 10}s`;
    petal.style.animationDuration = `${10 + Math.random() * 20}s`;
    
    container.appendChild(petal);
}

// Mobile menu toggle
function setupMobileMenu() {
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    
    if (mobileMenuToggle && mobileMenu) {
        mobileMenuToggle.addEventListener('click', function() {
            mobileMenu.classList.toggle('hidden');
            
            // Add animation
            if (!mobileMenu.classList.contains('hidden')) {
                gsap.fromTo(mobileMenu, 
                    { opacity: 0, height: 0 }, 
                    { opacity: 1, height: 'auto', duration: 0.3, ease: 'power2.out' }
                );
            }
        });
    }
}

// Theme toggle
function setupThemeToggle() {
    const themeToggle = document.getElementById('themeToggle');
    const mobileThemeToggle = document.getElementById('mobileThemeToggle');
    
    if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
    }
    
    if (mobileThemeToggle) {
        mobileThemeToggle.addEventListener('click', toggleTheme);
    }
}

// Toggle dark mode
function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    
    // Update theme icon
    if (isDarkMode) {
        this.innerHTML = '<i class="fas fa-sun"></i>';
    } else {
        this.innerHTML = '<i class="fas fa-moon"></i>';
    }
    
    // Update text colors based on theme
    applyThemeColors();
}

// Animate page elements
function animatePageElements() {
    const pageTitle = document.getElementById('pageTitle');
    const titleDivider = document.getElementById('titleDivider');
    const filterControls = document.getElementById('filterControls');
    const novelsItems = document.querySelectorAll('.novels-item');
    
    gsap.to(pageTitle, { opacity: 1, y: 0, duration: 0.5, delay: 0.2 });
    gsap.to(titleDivider, { opacity: 1, scaleX: 1, duration: 0.5, delay: 0.4 });
    gsap.to(filterControls, { opacity: 1, y: 0, duration: 0.5, delay: 0.6 });
    
    novelsItems.forEach((item, index) => {
        gsap.to(item, { opacity: 1, y: 0, duration: 0.5, delay: index * 0.1 + 0.8 });
    });
}

// Theme persistence using localStorage
function initializeTheme() {
    // Check if theme preference exists in localStorage
    const savedTheme = localStorage.getItem('theme');
    const themeToggle = document.getElementById('themeToggle');
    const mobileThemeToggle = document.getElementById('mobileThemeToggle');

    // Apply saved theme or default to light
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        if (themeToggle) themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        if (mobileThemeToggle) mobileThemeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }

    // Update localStorage when theme changes
    function updateThemeStorage() {
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Override existing toggleTheme function
    window.toggleTheme = function() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        
        const icon = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        if (themeToggle) themeToggle.innerHTML = icon;
        if (mobileThemeToggle) mobileThemeToggle.innerHTML = icon;

        updateThemeStorage();
        applyThemeColors();
    };
}

// Call on page load
document.addEventListener('DOMContentLoaded', initializeTheme);

// Enhanced function to filter novels by genre
function filterNovels() {
    // Set up click listeners for filter buttons
    const filterButtons = document.querySelectorAll('.filter-button');
    
    // Function to update button styles
    function updateButtonStyles(activeButton) {
        // Update styles for all buttons
        filterButtons.forEach(btn => {
            if (btn === activeButton) {
                // Active button styles
                btn.classList.add('active');
                btn.classList.add('bg-pink-500');
                btn.classList.add('text-white');
                btn.classList.remove('bg-white');
                btn.classList.remove('text-pink-500');
            } else {
                // Inactive button styles
                btn.classList.remove('active');
                btn.classList.remove('bg-pink-500');
                btn.classList.remove('text-white');
                btn.classList.add('bg-white');
                btn.classList.add('text-pink-500');
            }
        });
    }
    
    // Function to filter and display novels
    function filterAndDisplayNovels(selectedGenre) {
        // Get all novel cards
        const novelCards = document.querySelectorAll('.novel-card');
        let visibleCount = 0;
        
        // Filter novels
        novelCards.forEach(card => {
            // Get the novel ID from the card
            const novelId = parseInt(card.dataset.novelId);
            
            // Find the novel object
            const novel = novels.find(n => n.id === novelId);
            
            if (!novel) return;
            
            // Show/hide based on filter
            if (selectedGenre === 'All Novels') {
                // Show all novels
                card.style.display = 'flex';
                visibleCount++;
                
                // Animate the card back in
                gsap.to(card, { 
                    opacity: 1, 
                    y: 0, 
                    duration: 0.3, 
                    ease: 'power2.out' 
                });
            } else {
                // Check if the novel matches the selected genre
                if (novel.genre === selectedGenre) {
                    // Show and animate in
                    card.style.display = 'flex';
                    visibleCount++;
                    gsap.to(card, { 
                        opacity: 1, 
                        y: 0, 
                        duration: 0.3, 
                        ease: 'power2.out' 
                    });
                } else {
                    // Hide with animation
                    gsap.to(card, { 
                        opacity: 0, 
                        y: 20, 
                        duration: 0.3, 
                        ease: 'power2.in',
                        onComplete: function() {
                            card.style.display = 'none';
                        }
                    });
                }
            }
        });
        
        return visibleCount;
    }
    
    // Handle "no novels found" message
    function handleNoNovelsMessage(visibleCount, selectedGenre) {
        // Remove any existing "no novels" message
        const existingMessage = document.getElementById('noNovelsMessage');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // If no visible novels, add a message
        if (visibleCount === 0) {
            const novelsGrid = document.getElementById('novelsGrid');
            const message = document.createElement('div');
            message.id = 'noNovelsMessage';
            message.className = 'col-span-full text-center py-10 text-gray-500 dark:text-gray-400';
            message.innerHTML = `No novels found in the "${selectedGenre}" category.`;
            novelsGrid.appendChild(message);
        }
    }
    
    // Set up click event for each button
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update button styles
            updateButtonStyles(this);
            
            // Get selected genre (button text without extra spaces)
            let selectedGenre = this.textContent.trim();
            
            // Filter and display novels
            const visibleCount = filterAndDisplayNovels(selectedGenre);
            
            // Handle "no novels found" message after animations complete
            setTimeout(() => {
                handleNoNovelsMessage(visibleCount, selectedGenre);
            }, 350);
        });
    });
    
    // Make sure "All Novels" is selected by default at the start
    const allNovelsButton = Array.from(filterButtons).find(btn => btn.textContent.trim() === 'All Novels');
    if (allNovelsButton) {
        // Apply active styles to "All Novels" button
        updateButtonStyles(allNovelsButton);
        
        // Make sure all novels are visible initially
        filterAndDisplayNovels('All Novels');
    }
}

// Add swipe functionality for touch screens
function setupSwipeControls() {
    const txtViewerModal = document.getElementById('txtViewerModal');
    let touchStartX = 0;
    let touchEndX = 0;
    
    txtViewerModal.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
    }, false);
    
    txtViewerModal.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].clientX;
        handleSwipe();
    }, false);
    
    function handleSwipe() {
        const swipeThreshold = 50; // Minimum distance for swipe
        const swipeDistance = touchEndX - touchStartX;
        
        if (Math.abs(swipeDistance) > swipeThreshold) {
            if (swipeDistance > 0) {
                // Swipe right - go to previous episode
                if (!document.getElementById('prevEpisodeBtn').disabled) {
                    goToPrevEpisode();
                }
            } else {
                // Swipe left - go to next episode
                if (!document.getElementById('nextEpisodeBtn').disabled) {
                    goToNextEpisode();
                }
            }
        }
    }
}
